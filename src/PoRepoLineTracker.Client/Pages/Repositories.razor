@page "/"
@page "/repositories"
@inject HttpClient Http
@inject ILogger<Repositories> Logger
@using PoRepoLineTracker.Client.Models
@using PoRepoLineTracker.Domain.Models
@using PoRepoLineTracker.Application.Models
@using Radzen.Blazor

<h3>GitHub Repositories</h3>

@* Success/Error Messages *@
@if (!string.IsNullOrEmpty(pageState.AddRepoMessage))
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @pageState.AddRepoMessage
        <button type="button" class="btn-close" @onclick="() => pageState.AddRepoMessage = string.Empty"></button>
    </div>
}
@if (!string.IsNullOrEmpty(pageState.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @pageState.ErrorMessage
        <button type="button" class="btn-close" @onclick="() => pageState.ErrorMessage = string.Empty"></button>
    </div>
}

<h4>Existing Repositories</h4>
@if (pageState.IsLoadingRepositories)
{
    <p><em>Loading repositories...</em></p>
}
else if (!pageState.Repositories.Any())
{
    <p>No repositories added yet. <a href="/add-repository">Add one here!</a></p>
}
else
{
    <div class="mb-3 d-flex justify-content-between align-items-center">
        <span class="text-muted">(@(pageState.Repositories!.Count) repositories found - automatically analyzed when added)</span>
        <button class="btn btn-danger btn-sm" @onclick="RemoveAllRepositories" disabled="@isRemovingAll">
            @if (isRemovingAll)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <span>Removing...</span>
            }
            else
            {
                <i class="fas fa-trash-alt me-2"></i>
                <span>Remove ALL</span>
            }
        </button>
    </div>
}
    
    <table class="table">
        <thead>
            <tr>
                <th>Owner</th>
                <th>Name</th>
                <th>Last Analyzed</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var repo in pageState.Repositories ?? new List<GitHubRepository>())
            {
                <tr>
                    <td>@repo.Owner</td>
                    <td>@repo.Name</td>
                    <td>@(repo.LastAnalyzedCommitDate.HasValue ? repo.LastAnalyzedCommitDate.Value.ToString("MM/dd/yyyy HH:mm") : "Never")</td>
                    <td>
                        <span class="badge bg-success">âœ“ Analyzed</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" @onclick="() => ShowLineCountChart(repo.Id)">
                            @(selectedRepositoryId == repo.Id ? "Hide Chart" : "Show Chart")
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteRepository(repo.Id)" title="Delete Repository">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                @if (selectedRepositoryId == repo.Id)
                {
                    <tr>
                        <td colspan="5">
                            <div class="row">
                                <!-- Line Count History Chart -->
                                <div class="col-lg-8 col-md-12 mb-4">
                                    <div class="card mt-2 mb-2">
                                        <div class="card-header">
                                            <h5 class="mb-0">ðŸ“ˆ Line Count History for @repo.Name (Last 365 Days)</h5>
                                        </div>
                                        <div class="card-body">
                                            @if (isLoadingChartData)
                                            {
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading chart data...</span>
                                                    </div>
                                                    <p class="mt-2 mb-0"><em>Loading chart data...</em></p>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(chartErrorMessage))
                                            {
                                                <div class="alert alert-warning">
                                                    <h6 class="alert-heading">Chart Data Unavailable</h6>
                                                    <p class="mb-2">@chartErrorMessage</p>
                                                    <button class="btn btn-sm btn-outline-warning" @onclick="() => FetchLineCountHistory(repo.Id)">
                                                        <i class="fas fa-redo"></i> Retry
                                                    </button>
                                                </div>
                                            }
                                            else if (lineCountHistory != null && lineCountHistory.Any())
                                            {
                                                <RadzenChart Style="height: 400px; width: 100%;">
                                                    <RadzenLineSeries 
                                                        Data="@lineCountHistory" 
                                                        CategoryProperty="Date" 
                                                        ValueProperty="TotalLines" 
                                                        Title="Total Lines of Code"
                                                        Stroke="#2563eb"
                                                        StrokeWidth="4">
                                                        <RadzenMarkers MarkerType="MarkerType.Circle" />
                                                    </RadzenLineSeries>
                                                    <RadzenCategoryAxis>
                                                        <RadzenGridLines Visible="true" />
                                                    </RadzenCategoryAxis>
                                                    <RadzenValueAxis Min="0" Max="50000">
                                                        <RadzenGridLines Visible="true" />
                                                    </RadzenValueAxis>
                                                    <RadzenLegend Visible="true" />
                                                </RadzenChart>
                                            }
                                            else
                                            {
                                                <div class="text-center py-4 text-muted">
                                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                                    <p class="mb-0">No line count history available for the selected period.</p>
                                                    <small>Try analyzing the repository first or check back later.</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <!-- File Extension Percentages Column -->
                                <div class="col-lg-4 col-md-12 mb-4">
                                    <div class="card mt-2 mb-2">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-file-code me-2"></i>
                                                Top File Extensions by Lines
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            @if (fileExtensionPercentages != null && fileExtensionPercentages.Any())
                                            {
                                                <ul class="list-group list-group-flush">
                                                    @foreach (var ext in fileExtensionPercentages)
                                                    {
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <code>@ext.FileExtension</code>
                                                            <span class="badge bg-primary rounded-pill">@ext.Percentage.ToString("F2")%</span>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <p class="text-muted">No file extension data available.</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Data Table below chart -->
                                <div class="col-12">
                                    <div class="card mt-2">
                                        <div class="card-header">
                                            <h5 class="mb-0">Line Count Details</h5>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="table-responsive">
                                                <table class="table table-striped table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th>Date</th>
                                                            <th>Lines of Code</th>
                                                            <th>Difference from Previous</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (lineCountHistory != null && lineCountHistory.Any())
                                                        {
                                                            @for (int i = 0; i < lineCountHistory.Count; i++)
                                                            {
                                                                var item = lineCountHistory[i];
                                                                var previousItem = i > 0 ? lineCountHistory[i - 1] : null;
                                                                var difference = previousItem != null ? item.TotalLines - previousItem.TotalLines : 0;
                                                                var differenceClass = difference > 0 ? "text-success" : difference < 0 ? "text-danger" : "";
                                                                var differenceSign = difference > 0 ? "+" : "";
                                                                
                                                                <tr>
                                                                    <td>@item.Date.ToString("MM/dd/yyyy HH:mm")</td>
                                                                    <td>@item.TotalLines.ToString("N0")</td>
                                                                    <td class="@differenceClass">@differenceSign@difference.ToString("N0")</td>
                                                                </tr>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <tr>
                                                                <td colspan="3" class="text-center text-muted">No data available</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}


@code {
    private RepositoryPageState pageState = new();
    private HashSet<Guid> showAllCommitsFor = new();
    private Guid? selectedRepositoryId;
    private List<DailyLineCountDto>? lineCountHistory;
    private List<FileExtensionPercentageDto>? fileExtensionPercentages;
    private bool isLoadingChartData = false;
    private string chartErrorMessage = string.Empty;
    private bool isRemovingAll = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadRepositories();
    }

    private async Task ShowLineCountChart(Guid repositoryId)
    {
        Logger.LogInformation("ShowLineCountChart called for repository ID: {RepositoryId}", repositoryId);
        if (selectedRepositoryId == repositoryId)
        {
            // If already selected, deselect to hide the chart and percentages
            Logger.LogInformation("Deselecting repository ID: {RepositoryId}", repositoryId);
            selectedRepositoryId = null;
            lineCountHistory = null;
            fileExtensionPercentages = null; // Clear percentages
            chartErrorMessage = string.Empty;
            StateHasChanged();
        }
        else
        {
            Logger.LogInformation("Selecting repository ID: {RepositoryId}", repositoryId);
            selectedRepositoryId = repositoryId;
            await FetchLineCountHistory(repositoryId);
            await FetchFileExtensionPercentages(repositoryId); // Fetch percentages
            StateHasChanged();
        }
    }

    private async Task FetchLineCountHistory(Guid repositoryId)
    {
        isLoadingChartData = true;
        chartErrorMessage = string.Empty;
        lineCountHistory = null;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Fetching line count history for repository {RepositoryId}", repositoryId);
            lineCountHistory = await Http.GetFromJsonAsync<List<DailyLineCountDto>>($"/api/repositories/{repositoryId}/linehistory/365");
            
            if (lineCountHistory == null || !lineCountHistory.Any())
            {
                Logger.LogWarning("No line count history returned for repository {RepositoryId}", repositoryId);
                chartErrorMessage = "No line count history available for the last 365 days.";
            }
            else
            {
                Logger.LogInformation("Loaded {Count} data points for repository {RepositoryId}. First: {First} lines, Last: {Last} lines", 
                    lineCountHistory.Count, repositoryId, lineCountHistory.First().TotalLines, lineCountHistory.Last().TotalLines);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching line count history for repository {RepositoryId}: {Message}", repositoryId, ex.Message);
            chartErrorMessage = $"Error loading chart data: {ex.Message}";
        }
        finally
        {
            isLoadingChartData = false;
        }
    }

    // New method to fetch file extension percentages
    private async Task FetchFileExtensionPercentages(Guid repositoryId)
    {
        Logger.LogInformation("Fetching file extension percentages for repository ID: {RepositoryId}", repositoryId);
        try
        {
            fileExtensionPercentages = await Http.GetFromJsonAsync<List<FileExtensionPercentageDto>>($"/api/repositories/{repositoryId}/file-extension-percentages");
            if (fileExtensionPercentages == null || !fileExtensionPercentages.Any())
            {
                Logger.LogInformation("No file extension data found for repository ID: {RepositoryId}", repositoryId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching file extension percentages for repository {RepositoryId}: {Message}", repositoryId, ex.Message);
            // Decide if this error should block the chart or just show empty percentages
            // For now, it will just result in an empty list being displayed
        }
    }

    private async Task LoadRepositories()
    {
        pageState.IsLoadingRepositories = true;
        pageState.ClearMessages();
        
        try
        {
            var repositories = await Http.GetFromJsonAsync<List<GitHubRepository>>("/api/repositories");
            pageState.Repositories = repositories ?? new List<GitHubRepository>();
            Logger.LogInformation("Loaded {Count} repositories.", pageState.Repositories.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading repositories: {Message}", ex.Message);
            pageState.ErrorMessage = $"Error loading repositories: {ex.Message}";
        }
        finally
        {
            pageState.IsLoadingRepositories = false;
        }
    }

    private void ToggleShowAllCommits(Guid repositoryId)
    {
        if (showAllCommitsFor.Contains(repositoryId))
        {
            showAllCommitsFor.Remove(repositoryId);
        }
        else
        {
            showAllCommitsFor.Add(repositoryId);
        }
    }

    private async Task DeleteRepository(Guid repositoryId)
    {
        try
        {
            Logger.LogInformation("Deleting repository {RepositoryId}", repositoryId);

            var response = await Http.DeleteAsync($"/api/repositories/{repositoryId}");

            if (response.IsSuccessStatusCode)
            {
                // Remove the repository from the local list
                var repoToRemove = pageState.Repositories.FirstOrDefault(r => r.Id == repositoryId);
                if (repoToRemove != null)
                {
                    pageState.Repositories.Remove(repoToRemove);
                    pageState.AddRepoMessage = $"Repository '{repoToRemove.Owner}/{repoToRemove.Name}' deleted successfully!";
                }
                
                // Hide chart if it was being displayed
                if (selectedRepositoryId == repositoryId)
                {
                    selectedRepositoryId = null;
                }

                Logger.LogInformation("Repository {RepositoryId} deleted successfully", repositoryId);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                pageState.AddRepoMessage = $"Error deleting repository: {response.StatusCode} - {errorContent}";
                Logger.LogError("Failed to delete repository {RepositoryId}. Status: {StatusCode}, Content: {ErrorContent}", repositoryId, response.StatusCode, errorContent);
            }
        }
        catch (Exception ex)
        {
            pageState.AddRepoMessage = $"Error deleting repository: {ex.Message}";
            Logger.LogError(ex, "Error deleting repository {RepositoryId}: {Message}", repositoryId, ex.Message);
        }
        finally
        {
            StateHasChanged();
        }
    }
    
    
    private async Task RemoveAllRepositories()
    {
        try
        {
            isRemovingAll = true;
            Logger.LogInformation("Starting removal of all repositories via API endpoint.");
            
            var response = await Http.DeleteAsync("/api/repositories/all");
            
            if (response.IsSuccessStatusCode)
            {
                // Clear the local repositories list
                pageState.Repositories.Clear();
                
                // Hide any open charts
                selectedRepositoryId = null;
                lineCountHistory = null;
                fileExtensionPercentages = null;
                chartErrorMessage = string.Empty;
                
                pageState.AddRepoMessage = "All repositories and data have been successfully removed!";
                Logger.LogInformation("All repositories removed successfully.");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                pageState.AddRepoMessage = $"Error removing all repositories: {response.StatusCode} - {errorContent}";
                Logger.LogError("Failed to remove all repositories. Status: {StatusCode}, Content: {ErrorContent}", response.StatusCode, errorContent);
            }
        }
        catch (Exception ex)
        {
            pageState.AddRepoMessage = $"Error removing all repositories: {ex.Message}";
            Logger.LogError(ex, "Error removing all repositories: {Message}", ex.Message);
        }
        finally
        {
            isRemovingAll = false;
            StateHasChanged();
        }
    }
}
