@page "/"
@page "/repositories"
@inject HttpClient Http
@inject ILogger<Repositories> Logger
@using PoRepoLineTracker.Client.Models
@using PoRepoLineTracker.Domain.Models
@using PoRepoLineTracker.Application.Models
@using Radzen.Blazor

<h3>GitHub Repositories</h3>

<div class="mb-3">
    <h4>Add New Repository</h4>
    <div class="input-group mb-3">
        <input type="text" class="form-control" @bind="pageState.NewRepoCloneUrl" placeholder="GitHub Repository URL (e.g., https://github.com/octocat/Spoon-Knife)" />
        <button class="btn btn-primary" @onclick="AddRepository">Add Repository</button>
    </div>
    @if (!string.IsNullOrEmpty(pageState.AddRepoMessage))
    {
        <div class="alert alert-info">@pageState.AddRepoMessage</div>
    }
</div>

<h4>Existing Repositories</h4>
@if (pageState.IsLoadingRepositories)
{
    <p><em>Loading repositories...</em></p>
}
else if (!pageState.Repositories.Any())
{
    <p>No repositories added yet. Add one above!</p>
}
else
{
    <div class="mb-3">
        <button class="btn btn-success" @onclick="AnalyzeAllRepositories" disabled="@pageState.IsAnalyzing">
            @if (pageState.IsAnalyzing)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                <text>Analyzing @pageState.CurrentAnalyzingRepo...</text>
            }
            else
            {
                <text>Analyze All Repositories</text>
            }
        </button>
        @if (pageState.Repositories?.Any() == true)
        {
            <span class="ms-3 text-muted">(@pageState.Repositories.Count repositories found)</span>
        }
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Owner</th>
                <th>Name</th>
                <th>Last Analyzed</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var repo in pageState.Repositories)
            {
                <tr class="@(pageState.AnalysisResults.ContainsKey(repo.Id) ? "table-success" : "")">
                    <td>@repo.Owner</td>
                    <td>@repo.Name</td>
                    <td>@(repo.LastAnalyzedCommitDate == DateTime.MinValue ? "Never" : repo.LastAnalyzedCommitDate.ToString("MM/dd/yyyy HH:mm"))</td>
                    <td>
                        @if (pageState.CurrentlyAnalyzing.Contains(repo.Id))
                        {
                            <span class="badge bg-primary">
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                Analyzing...
                            </span>
                        }
                        else if (pageState.AnalysisResults.ContainsKey(repo.Id))
                        {
                            <span class="badge bg-success">âœ“ @pageState.AnalysisResults[repo.Id] commits</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Ready</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" @onclick="() => ShowLineCountChart(repo.Id)">
                            @(selectedRepositoryId == repo.Id ? "Hide Chart" : "Show Chart")
                        </button>
                    </td>
                </tr>
                @if (selectedRepositoryId == repo.Id)
                {
                    <tr>
                        <td colspan="5">
                            <div class="card mt-2 mb-2">
                                <div class="card-header">
                                    <h5 class="mb-0">Line Count History for @repo.Name (Last 30 Days)</h5>
                                </div>
                                <div class="card-body">
                                    @if (isLoadingChartData)
                                    {
                                        <p><em>Loading chart data...</em></p>
                                    }
                                    else if (!string.IsNullOrEmpty(chartErrorMessage))
                                    {
                                        <div class="alert alert-warning">@chartErrorMessage</div>
                                    }
                                    else if (lineCountHistory != null && lineCountHistory.Any())
                                    {
                                        <RadzenChart>
                                            <RadzenLineSeries Data="@lineCountHistory" CategoryProperty="Date" ValueProperty="TotalLines" Title="Total Lines of Code">
                                                <RadzenSeriesDataLabels Visible="false" />
                                            </RadzenLineSeries>
                                            <RadzenCategoryAxis FormatString="{0:MM/dd}" />
                                            <RadzenValueAxis>
                                                <RadzenGridLines Visible="true" />
                                                <RadzenAxisTitle Text="Lines of Code" />
                                            </RadzenValueAxis>
                                            <RadzenLegend Visible="true" />
                                        </RadzenChart>
                                    }
                                    else
                                    {
                                        <p class="text-muted">No line count history available.</p>
                                    }
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@if (pageState.DetailedResults?.Any() == true)
{
    <h4>Analysis Results</h4>
    <p>Total Repositories Analyzed: @pageState.DetailedResults.Count | Total Commits: @pageState.DetailedResults.Sum(r => r.Commits.Count)</p>
    
    @foreach (var repoResult in pageState.DetailedResults.OrderByDescending(r => r.Commits.Count))
    {
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">
                    @repoResult.RepositoryName
                    <span class="badge bg-primary ms-2">@repoResult.Commits.Count commits</span>
                    <span class="badge bg-info ms-1">@repoResult.Commits.Sum(c => c.TotalLines) total lines</span>
                </h5>
            </div>
            <div class="card-body">
                @if (repoResult.Commits.Any())
                {
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Recent Commits (Latest 5)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Lines</th>
                                            <th>SHA</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var commit in repoResult.Commits.OrderByDescending(c => c.CommitDate).Take(5))
                                        {
                                            <tr>
                                                <td>@commit.CommitDate.ToString("MM/dd HH:mm")</td>
                                                <td>@commit.TotalLines</td>
                                                <td><code>@commit.CommitSha.Substring(0, 8)</code></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Code Growth Trend</h6>
                            <div class="d-flex flex-column">
                                <small class="text-muted">Latest Commit: @repoResult.Commits.OrderByDescending(c => c.CommitDate).First().CommitDate.ToString("MM/dd/yyyy")</small>
                                <small class="text-muted">Current Lines: @repoResult.Commits.OrderByDescending(c => c.CommitDate).First().TotalLines</small>
                                <small class="text-muted">File Types: @string.Join(", ", repoResult.Commits.SelectMany(c => c.LinesByFileType.Keys).Distinct())</small>
                            </div>
                            @if (repoResult.Commits.Count > 5)
                            {
                                <button class="btn btn-sm btn-outline-primary mt-2" @onclick="() => ToggleShowAllCommits(repoResult.RepositoryId)">
                                    @if (showAllCommitsFor.Contains(repoResult.RepositoryId))
                                    {
                                        <text>Show Less</text>
                                    }
                                    else
                                    {
                                        <text>Show All @repoResult.Commits.Count Commits</text>
                                    }
                                </button>
                            }
                        </div>
                    </div>
                    
                    @if (showAllCommitsFor.Contains(repoResult.RepositoryId) && repoResult.Commits.Count > 5)
                    {
                        <div class="mt-3">
                            <h6>All Commits</h6>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm">
                                    <thead class="sticky-top bg-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Total Lines</th>
                                            <th>Commit SHA</th>
                                            <th>File Types</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var commit in repoResult.Commits.OrderByDescending(c => c.CommitDate))
                                        {
                                            <tr>
                                                <td>@commit.CommitDate.ToString("MM/dd HH:mm")</td>
                                                <td>@commit.TotalLines</td>
                                                <td><code>@commit.CommitSha.Substring(0, 8)</code></td>
                                                <td>
                                                    @foreach (var fileType in commit.LinesByFileType.Where(ft => ft.Value > 0).Take(3))
                                                    {
                                                        <small class="badge bg-light text-dark me-1">@fileType.Key: @fileType.Value</small>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">No commits analyzed yet.</p>
                }
            </div>
        </div>
    }
}

@code {
    private RepositoryPageState pageState = new();
    private HashSet<Guid> showAllCommitsFor = new();
    private Guid? selectedRepositoryId;
    private List<DailyLineCountDto>? lineCountHistory;
    private bool isLoadingChartData = false;
    private string chartErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadRepositories();
    }

    private async Task ShowLineCountChart(Guid repositoryId)
    {
        Logger.LogInformation("ShowLineCountChart called for repository ID: {RepositoryId}", repositoryId); // Add this line
        if (selectedRepositoryId == repositoryId)
        {
            // If already selected, deselect to hide the chart
            selectedRepositoryId = null;
            lineCountHistory = null;
            chartErrorMessage = string.Empty;
            StateHasChanged(); // Add this
        }
        else
        {
            selectedRepositoryId = repositoryId;
            await FetchLineCountHistory(repositoryId);
            StateHasChanged(); // Add this
        }
    }

    private async Task FetchLineCountHistory(Guid repositoryId)
    {
        isLoadingChartData = true;
        chartErrorMessage = string.Empty;
        lineCountHistory = null;
        StateHasChanged(); // Add this to show loading state immediately

        try
        {
            lineCountHistory = await Http.GetFromJsonAsync<List<DailyLineCountDto>>($"/api/repositories/{repositoryId}/linehistory/30");
            if (lineCountHistory == null || !lineCountHistory.Any())
            {
                chartErrorMessage = "No line count history available for the last 30 days.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching line count history for repository {RepositoryId}: {Message}", repositoryId, ex.Message);
            chartErrorMessage = $"Error loading chart data: {ex.Message}";
        }
        finally
        {
            isLoadingChartData = false;
        }
    }

    private async Task LoadRepositories()
    {
        pageState.IsLoadingRepositories = true;
        pageState.ClearMessages();
        
        try
        {
            var repositories = await Http.GetFromJsonAsync<List<GitHubRepository>>("/api/repositories");
            pageState.Repositories = repositories ?? new List<GitHubRepository>();
            Logger.LogInformation("Loaded {Count} repositories.", pageState.Repositories.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading repositories: {Message}", ex.Message);
            pageState.ErrorMessage = $"Error loading repositories: {ex.Message}";
        }
        finally
        {
            pageState.IsLoadingRepositories = false;
        }
    }

    private async Task AddRepository()
    {
        pageState.AddRepoMessage = "Adding repository...";
        pageState.ClearMessages();
        
        try
        {
            // Parse owner and repo name from the URL
            var uri = new Uri(pageState.NewRepoCloneUrl);
            var pathSegments = uri.Segments.Where(s => s != "/").Select(s => s.Trim('/')).ToList();

            if (pathSegments.Count < 2)
            {
                pageState.AddRepoMessage = "Error: Invalid GitHub repository URL. Please provide a URL like https://github.com/owner/repo.";
                return;
            }

            var owner = pathSegments[0];
            var repoName = pathSegments[1].Replace(".git", ""); // Remove .git if present

            var newRepository = new GitHubRepository
            {
                Owner = owner,
                Name = repoName,
                CloneUrl = pageState.NewRepoCloneUrl
            };

            var response = await Http.PostAsJsonAsync("/api/repositories", newRepository);
            
            if (response.IsSuccessStatusCode)
            {
                var addedRepo = await response.Content.ReadFromJsonAsync<GitHubRepository>();
                pageState.AddRepoMessage = $"Repository '{addedRepo?.Name}' added successfully!";
                pageState.NewRepoCloneUrl = "";
                await LoadRepositories(); // Refresh the list
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                pageState.AddRepoMessage = errorResponse?.error ?? $"Repository '{owner}/{repoName}' is already in your list.";
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                pageState.AddRepoMessage = $"Error adding repository: {response.StatusCode} - {errorContent}";
            }
        }
        catch (Exception ex)
        {
            pageState.AddRepoMessage = $"Error adding repository: {ex.Message}";
            Logger.LogError(ex, "Error adding repository: {Message}", ex.Message);
        }
    }

    private async Task AnalyzeAllRepositories()
    {
        if (pageState.Repositories == null || !pageState.Repositories.Any())
        {
            pageState.AddRepoMessage = "No repositories to analyze. Please add some repositories first.";
            return;
        }

        pageState.IsAnalyzing = true;
        pageState.DetailedResults = new List<RepositoryAnalysisResult>();
        pageState.AnalysisResults.Clear();
        pageState.CurrentlyAnalyzing.Clear();
        pageState.AddRepoMessage = "Starting analysis of all repositories...";
        StateHasChanged();

        try
        {
            foreach (var repo in pageState.Repositories)
            {
                pageState.CurrentAnalyzingRepo = $"{repo.Owner}/{repo.Name}";
                pageState.CurrentlyAnalyzing.Add(repo.Id);
                StateHasChanged();

                try
                {
                    // Step 1: Analyze commits
                    pageState.AddRepoMessage = $"Analyzing commits for {pageState.CurrentAnalyzingRepo}...";
                    var analyzeResponse = await Http.PostAsync($"/api/repositories/{repo.Id}/analyze", null);
                    
                    if (!analyzeResponse.IsSuccessStatusCode)
                    {
                        Logger.LogWarning("Failed to analyze repository {RepoName}: {StatusCode}", pageState.CurrentAnalyzingRepo, analyzeResponse.StatusCode);
                        continue;
                    }

                    // Step 2: Get line counts
                    pageState.AddRepoMessage = $"Retrieving line counts for {pageState.CurrentAnalyzingRepo}...";
                    var lineCounts = await Http.GetFromJsonAsync<List<CommitLineCount>>($"/api/repositories/{repo.Id}/linecounts");
                    
                    if (lineCounts != null)
                    {
                        var sortedCommits = lineCounts.OrderByDescending(lc => lc.CommitDate).ToList();
                        
                        pageState.DetailedResults.Add(new RepositoryAnalysisResult
                        {
                            RepositoryId = repo.Id,
                            RepositoryName = $"{repo.Owner}/{repo.Name}",
                            Commits = sortedCommits
                        });

                        pageState.AnalysisResults[repo.Id] = sortedCommits.Count;
                        Logger.LogInformation("Analyzed {CommitCount} commits for {RepoName}", sortedCommits.Count, pageState.CurrentAnalyzingRepo);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error analyzing repository {RepoName}: {Message}", pageState.CurrentAnalyzingRepo, ex.Message);
                }
                finally
                {
                    pageState.CurrentlyAnalyzing.Remove(repo.Id);
                    StateHasChanged();
                }
            }

            // Refresh repository list to get updated LastAnalyzedCommitDate
            await LoadRepositories();
            
            var totalCommits = pageState.DetailedResults.Sum(r => r.Commits.Count);
            pageState.AddRepoMessage = $"Analysis complete! Processed {pageState.DetailedResults.Count} repositories with {totalCommits} total commits.";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during bulk analysis: {Message}", ex.Message);
            pageState.AddRepoMessage = $"Error during analysis: {ex.Message}";
        }
        finally
        {
            pageState.IsAnalyzing = false;
            pageState.CurrentAnalyzingRepo = "";
            pageState.CurrentlyAnalyzing.Clear();
            StateHasChanged();
        }
    }

    private void ToggleShowAllCommits(Guid repositoryId)
    {
        if (pageState.ShowAllCommitsFor.Contains(repositoryId))
        {
            pageState.ShowAllCommitsFor.Remove(repositoryId);
        }
        else
        {
            pageState.ShowAllCommitsFor.Add(repositoryId);
        }
    }
}
