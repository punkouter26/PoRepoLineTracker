@page "/"
@page "/repositories"
@inject HttpClient Http
@inject ILogger<Repositories> Logger
@using PoRepoLineTracker.Client.Models
@using PoRepoLineTracker.Domain.Models
@using PoRepoLineTracker.Application.Models
@using Radzen.Blazor

<h3>GitHub Repositories</h3>

<div class="mb-3">
    <h4>Add New Repository</h4>
    <div class="input-group mb-3">
        <RadzenDropDown @bind-Value="pageState.SelectedGitHubRepository"
                        Data="@pageState.GitHubUserRepositories"
                        TextProperty="Name"
                        Placeholder="Select a repository from your GitHub account..."
                        Style="min-width: 300px;"
                        Disabled="@(pageState.IsAddingRepository || pageState.IsLoadingGitHubRepos)"
                        class="form-control" />
        <button class="btn btn-primary" @onclick="AddRepository" disabled="@(pageState.IsAddingRepository || pageState.SelectedGitHubRepository == null)">
            @if (pageState.IsAddingRepository)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            }
            Add Repository
        </button>
    </div>
    
    @if (pageState.IsLoadingGitHubRepos)
    {
        <div class="mb-3">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading GitHub repositories...</span>
                </div>
                <p class="mt-2"><em>Loading your GitHub repositories...</em></p>
            </div>
        </div>
    }
    
    @if (pageState.IsAddingRepository)
    {
        <div class="mb-3">
            <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: @(pageState.ProgressPercentage)%" 
                     aria-valuenow="@pageState.ProgressPercentage" 
                     aria-valuemin="0" 
                     aria-valuemax="100">
                    @(pageState.ProgressPercentage)%
                </div>
            </div>
            <div class="text-center mt-2">
                <small class="text-muted">@pageState.ProgressMessage</small>
            </div>
        </div>
    }
    
    @if (!string.IsNullOrEmpty(pageState.AddRepoMessage))
    {
        <div class="alert alert-info">@pageState.AddRepoMessage</div>
    }
</div>

<h4>Existing Repositories</h4>
@if (pageState.IsLoadingRepositories)
{
    <p><em>Loading repositories...</em></p>
}
else if (!pageState.Repositories.Any())
{
    <p>No repositories added yet. Add one above!</p>
}
else
{
    <div class="mb-3">
        @if (pageState.Repositories?.Any() == true)
        {
            <span class="text-muted">(@pageState.Repositories.Count repositories found - automatically analyzed when added)</span>
        }
    </div>
    
    <table class="table">
        <thead>
            <tr>
                <th>Owner</th>
                <th>Name</th>
                <th>Last Analyzed</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var repo in pageState.Repositories)
            {
                <tr>
                    <td>@repo.Owner</td>
                    <td>@repo.Name</td>
                    <td>@(repo.LastAnalyzedCommitDate == DateTime.MinValue ? "Never" : repo.LastAnalyzedCommitDate.ToString("MM/dd/yyyy HH:mm"))</td>
                    <td>
                        <span class="badge bg-success">âœ“ Analyzed</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info me-2" @onclick="() => ShowLineCountChart(repo.Id)">
                            @(selectedRepositoryId == repo.Id ? "Hide Chart" : "Show Chart")
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteRepository(repo.Id)" title="Delete Repository">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                @if (selectedRepositoryId == repo.Id)
                {
                    <tr>
                        <td colspan="5">
                            <div class="row">
                                <div class="col-lg-8 col-md-12 mb-4"> @* Chart Column - 80% width *@
                                    <div class="card mt-2 mb-2">
                                        <div class="card-header">
                                            <h5 class="mb-0">Line Count History for @repo.Name (Last 30 Days)</h5>
                                        </div>
                                        <div class="card-body">
                                            @if (isLoadingChartData)
                                            {
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading chart data...</span>
                                                    </div>
                                                    <p class="mt-2 mb-0"><em>Loading chart data...</em></p>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(chartErrorMessage))
                                            {
                                                <div class="alert alert-warning">
                                                    <h6 class="alert-heading">Chart Data Unavailable</h6>
                                                    <p class="mb-2">@chartErrorMessage</p>
                                                    <button class="btn btn-sm btn-outline-warning" @onclick="() => FetchLineCountHistory(repo.Id)">
                                                        <i class="fas fa-redo"></i> Retry
                                                    </button>
                                                </div>
                                            }
                                            else if (lineCountHistory != null && lineCountHistory.Any())
                                            {
                                                <RadzenChart>
                                                    <RadzenLineSeries Data="@lineCountHistory" CategoryProperty="Date" ValueProperty="TotalLines" Title="Total Lines of Code">
                                                        <RadzenSeriesDataLabels Visible="false" />
                                                    </RadzenLineSeries>
                                                    <RadzenCategoryAxis FormatString="{0:MM/dd}" />
                                                    <RadzenValueAxis>
                                                        <RadzenGridLines Visible="true" />
                                                        <RadzenAxisTitle Text="Lines of Code" />
                                                    </RadzenValueAxis>
                                                    <RadzenLegend Visible="true" />
                                                </RadzenChart>
                                            }
                                            else
                                            {
                                                <div class="text-center py-4 text-muted">
                                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                                    <p class="mb-0">No line count history available for the selected period.</p>
                                                    <small>Try analyzing the repository first or check back later.</small>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-4 col-md-12 mb-4"> @* File Extension Percentages Column - 20% width *@
                                    <div class="card mt-2 mb-2">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="fas fa-file-code me-2"></i>
                                                Top File Extensions by Lines
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            @if (fileExtensionPercentages != null && fileExtensionPercentages.Any())
                                            {
                                                <ul class="list-group list-group-flush">
                                                    @foreach (var ext in fileExtensionPercentages)
                                                    {
                                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                                            <code>@ext.FileExtension</code>
                                                            <span class="badge bg-primary rounded-pill">@ext.Percentage.ToString("F2")%</span>
                                                        </li>
                                                    }
                                                </ul>
                                            }
                                            else
                                            {
                                                <p class="text-muted">No file extension data available.</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
}

@code {
    private RepositoryPageState pageState = new();
    private HashSet<Guid> showAllCommitsFor = new();
    private Guid? selectedRepositoryId;
    private List<DailyLineCountDto>? lineCountHistory;
    private List<FileExtensionPercentageDto>? fileExtensionPercentages; // New property
    private bool isLoadingChartData = false;
    private string chartErrorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadRepositories();
        await LoadGitHubRepositories();
    }

    private async Task ShowLineCountChart(Guid repositoryId)
    {
        Logger.LogInformation("ShowLineCountChart called for repository ID: {RepositoryId}", repositoryId);
        if (selectedRepositoryId == repositoryId)
        {
            // If already selected, deselect to hide the chart and percentages
            Logger.LogInformation("Deselecting repository ID: {RepositoryId}", repositoryId);
            selectedRepositoryId = null;
            lineCountHistory = null;
            fileExtensionPercentages = null; // Clear percentages
            chartErrorMessage = string.Empty;
            StateHasChanged();
        }
        else
        {
            Logger.LogInformation("Selecting repository ID: {RepositoryId}", repositoryId);
            selectedRepositoryId = repositoryId;
            await FetchLineCountHistory(repositoryId);
            await FetchFileExtensionPercentages(repositoryId); // Fetch percentages
            StateHasChanged();
        }
    }

    private async Task FetchLineCountHistory(Guid repositoryId)
    {
        isLoadingChartData = true;
        chartErrorMessage = string.Empty;
        lineCountHistory = null;
        StateHasChanged();

        try
        {
            lineCountHistory = await Http.GetFromJsonAsync<List<DailyLineCountDto>>($"/api/repositories/{repositoryId}/linehistory/30");
            if (lineCountHistory == null || !lineCountHistory.Any())
            {
                chartErrorMessage = "No line count history available for the last 30 days.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching line count history for repository {RepositoryId}: {Message}", repositoryId, ex.Message);
            chartErrorMessage = $"Error loading chart data: {ex.Message}";
        }
        finally
        {
            isLoadingChartData = false;
        }
    }

    // New method to fetch file extension percentages
    private async Task FetchFileExtensionPercentages(Guid repositoryId)
    {
        Logger.LogInformation("Fetching file extension percentages for repository ID: {RepositoryId}", repositoryId);
        try
        {
            fileExtensionPercentages = await Http.GetFromJsonAsync<List<FileExtensionPercentageDto>>($"/api/repositories/{repositoryId}/file-extension-percentages");
            if (fileExtensionPercentages == null || !fileExtensionPercentages.Any())
            {
                Logger.LogInformation("No file extension data found for repository ID: {RepositoryId}", repositoryId);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error fetching file extension percentages for repository {RepositoryId}: {Message}", repositoryId, ex.Message);
            // Decide if this error should block the chart or just show empty percentages
            // For now, it will just result in an empty list being displayed
        }
    }

    private async Task LoadRepositories()
    {
        pageState.IsLoadingRepositories = true;
        pageState.ClearMessages();
        
        try
        {
            var repositories = await Http.GetFromJsonAsync<List<GitHubRepository>>("/api/repositories");
            pageState.Repositories = repositories ?? new List<GitHubRepository>();
            Logger.LogInformation("Loaded {Count} repositories.", pageState.Repositories.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading repositories: {Message}", ex.Message);
            pageState.ErrorMessage = $"Error loading repositories: {ex.Message}";
        }
        finally
        {
            pageState.IsLoadingRepositories = false;
        }
    }

    private async Task LoadGitHubRepositories()
    {
        pageState.IsLoadingGitHubRepos = true;
        StateHasChanged();
        
        try
        {
            var gitHubRepos = await Http.GetFromJsonAsync<List<GitHubUserRepositoryDto>>("/api/github/user-repositories");
            // Sort repositories alphabetically by name
            pageState.GitHubUserRepositories = gitHubRepos?.OrderBy(r => r.Name).ToList() ?? new List<GitHubUserRepositoryDto>();
            Logger.LogInformation("Loaded {Count} GitHub user repositories.", pageState.GitHubUserRepositories.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading GitHub repositories: {Message}", ex.Message);
            pageState.ErrorMessage = $"Error loading GitHub repositories: {ex.Message}";
        }
        finally
        {
            pageState.IsLoadingGitHubRepos = false;
            StateHasChanged();
        }
    }

    private async Task AddRepository()
    {
        if (pageState.IsAddingRepository || pageState.SelectedGitHubRepository == null) return;
        
        pageState.IsAddingRepository = true;
        pageState.ClearMessages();
        StateHasChanged();
        
        try
        {
            // Step 1: Validate selected repository (10%)
            pageState.SetProgress("Validating selected repository...", 10);
            StateHasChanged();
            await Task.Delay(300);
            
            var selectedRepo = pageState.SelectedGitHubRepository;

            // Step 2: Prepare repository data (25%)
            pageState.SetProgress("Preparing repository data...", 25);
            StateHasChanged();
            await Task.Delay(300);

            // Parse owner and repo name from the full name (e.g., "owner/repo")
            var fullNameParts = selectedRepo.FullName.Split('/');
            if (fullNameParts.Length != 2)
            {
                pageState.AddRepoMessage = "Error: Invalid repository format in GitHub data.";
                return;
            }

            var newRepository = new GitHubRepository
            {
                Owner = fullNameParts[0],
                Name = fullNameParts[1],
                CloneUrl = selectedRepo.CloneUrl
            };

            // Step 3: Adding to database (50%)
            pageState.SetProgress("Adding repository to database...", 50);
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("/api/repositories", newRepository);
            
            if (response.IsSuccessStatusCode)
            {
                // Step 4: Repository added successfully (75%)
                pageState.SetProgress("Repository added! Initializing analysis...", 75);
                StateHasChanged();
                await Task.Delay(500);

                var addedRepo = await response.Content.ReadFromJsonAsync<GitHubRepository>();
                
                // Step 5: Complete (100%)
                pageState.SetProgress("Complete! Repository is now being analyzed.", 100);
                StateHasChanged();
                await Task.Delay(1000);

                pageState.AddRepoMessage = $"Repository '{addedRepo?.Name}' added successfully! Analysis will begin automatically.";
                pageState.SelectedGitHubRepository = null; // Clear selection
                await LoadRepositories();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                pageState.SetProgress("Repository already exists", 100);
                StateHasChanged();
                await Task.Delay(500);

                var errorResponse = await response.Content.ReadFromJsonAsync<ErrorResponse>();
                pageState.AddRepoMessage = errorResponse?.error ?? $"Repository '{selectedRepo.Name}' is already in your list.";
            }
            else
            {
                pageState.SetProgress("Error occurred", 100);
                StateHasChanged();
                await Task.Delay(500);

                var errorContent = await response.Content.ReadAsStringAsync();
                pageState.AddRepoMessage = $"Error adding repository: {response.StatusCode} - {errorContent}";
            }
        }
        catch (Exception ex)
        {
            pageState.SetProgress("Error occurred", 100);
            StateHasChanged();
            await Task.Delay(500);

            pageState.AddRepoMessage = $"Error adding repository: {ex.Message}";
            Logger.LogError(ex, "Error adding repository: {Message}", ex.Message);
        }
        finally
        {
            pageState.IsAddingRepository = false;
            pageState.ProgressMessage = string.Empty;
            pageState.ProgressPercentage = 0;
            StateHasChanged();
        }
    }

    private void ToggleShowAllCommits(Guid repositoryId)
    {
        if (pageState.ShowAllCommitsFor.Contains(repositoryId))
        {
            pageState.ShowAllCommitsFor.Remove(repositoryId);
        }
        else
        {
            pageState.ShowAllCommitsFor.Add(repositoryId);
        }
    }

    private async Task DeleteRepository(Guid repositoryId)
    {
        try
        {
            Logger.LogInformation("Deleting repository {RepositoryId}", repositoryId);

            var response = await Http.DeleteAsync($"/api/repositories/{repositoryId}");

            if (response.IsSuccessStatusCode)
            {
                // Remove the repository from the local list
                var repoToRemove = pageState.Repositories.FirstOrDefault(r => r.Id == repositoryId);
                if (repoToRemove != null)
                {
                    pageState.Repositories.Remove(repoToRemove);
                    pageState.AddRepoMessage = $"Repository '{repoToRemove.Owner}/{repoToRemove.Name}' deleted successfully!";
                }
                
                // Hide chart if it was being displayed
                if (selectedRepositoryId == repositoryId)
                {
                    selectedRepositoryId = null;
                }

                Logger.LogInformation("Repository {RepositoryId} deleted successfully", repositoryId);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                pageState.AddRepoMessage = $"Error deleting repository: {response.StatusCode} - {errorContent}";
                Logger.LogError("Failed to delete repository {RepositoryId}. Status: {StatusCode}, Content: {ErrorContent}", repositoryId, response.StatusCode, errorContent);
            }
        }
        catch (Exception ex)
        {
            pageState.AddRepoMessage = $"Error deleting repository: {ex.Message}";
            Logger.LogError(ex, "Error deleting repository {RepositoryId}: {Message}", repositoryId, ex.Message);
        }
        finally
        {
            StateHasChanged();
        }
    }
}
